name: Publish to PyPI

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

jobs:
    build-and-publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Poetry
              run: |
                  curl -sSL https://install.python-poetry.org | python3 -
                  echo "$HOME/.local/bin" >> $GITHUB_PATH

            - name: Configure Poetry
              run: |
                  poetry config virtualenvs.create false
                  poetry config pypi-token.pypi ${{ secrets.PYPI_API_TOKEN }}

            - name: Install dependencies
              run: poetry install --no-root

            - name: Build package
              run: poetry build

            - name: Check if version exists on PyPI
              id: check_version
              run: |
                  VERSION=$(poetry version -s)
                  if pip index versions ai-hydra | grep -q "$VERSION"; then
                    echo "version_exists=true" >> $GITHUB_OUTPUT
                    echo "‚ö†Ô∏è Version $VERSION already exists on PyPI"
                  else
                    echo "version_exists=false" >> $GITHUB_OUTPUT
                    echo "‚úÖ Version $VERSION is new, proceeding with publish"
                  fi

            - name: Publish to PyPI
              if: steps.check_version.outputs.version_exists == 'false'
              run: poetry publish

            - name: Skip publish (version exists)
              if: steps.check_version.outputs.version_exists == 'true'
              run: |
                  VERSION=$(poetry version -s)
                  echo "‚ùå Skipping publish - version $VERSION already exists on PyPI"
                  echo "üí° To publish a new version, run: ./scripts/update-version.sh \"X.Y.Z\" \"Description\""
                  exit 1
